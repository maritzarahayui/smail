<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <object th:include="~{fragments/common :: js}" th:remove="tag"></object>
    <object th:include="~{fragments/common :: css}" th:remove="tag"></object>

    <link rel="stylesheet" href="/css/request-surat.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700&display=swap"/>
    <link rel="stylesheet" href="/css/global-daftar-template.css"/>

</head>

<body>

<nav th:replace="~{fragments/navbarLoggedIn :: navbarLoggedIn}"></nav>

<div class="content-container">

    <nav th:replace="~{fragments/asset :: asset}"></nav>

    <b class="title-container">
        <span class="title-gradient">Pengajuan</span>
        <span> Permohonan Surat</span>
    </b>

    <form th:action="@{/request}" th:object="${requestDTO}" method="POST" class="formRequest" enctype="multipart/form-data">
        <div class="text-input">
            <div class="label">Bahasa</div>
            <div class="text-input7">
                <select name="bahasa" class="form-select" th:field="*{bahasa}">
                    <option value="">Pilih Bahasa Surat</option>
                    <option th:each="entry : ${listBahasa}" th:value="${entry.value}" th:text="${entry.value}"></option>
                </select>
            </div>
        </div>

        <div class="label-parent">
            <div class="label">Bentuk Surat</div>
            <div class="frame-parent">
                <div class="radio-parent">
                    <input type="checkbox" id="softCopy" name="bentukSurat" value="Soft Copy" />
                    <div class="label-group">
                        <div class="body-14pt">Soft Copy</div>
                        <div class="body-14pt">Surat dapat diunduh di website ini.</div>
                    </div>
                </div>
                <div class="radio-parent">
                    <input type="checkbox" id="hardCopy" name="bentukSurat" value="Hard Copy" />
                    <div class="label-group">
                        <div class="body-14pt">Hard Copy</div>
                        <div class="body-14pt">Surat dapat diambil di kantor administrasi.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-input">
            <div class="label">Keperluan</div>
            <div class="text-input7">
                <input type="text" class="form-control" th:field="*{keperluan}" required/>
            </div>
        </div>

        <div class="text-input">
            <div class="label">Kategori Surat</div>
            <div class="text-input7">
                <select id="kategori" name="kategori" class="form-select" th:field="*{kategori}">
                    <option value="">Pilih Kategori Surat</option>
                    <option th:each="entry : ${jenisSuratByKategori}" th:value="${entry.key}" th:text="${entry.key}"></option>
                </select>
            </div>
        </div>

        <div>
            <div class="text-input" id="jenisSuratWrapper">
                <div class="label" style="padding-bottom:16px;">Jenis Surat</div>
                <div class="text-input7">
                    <select id="jenisSurat" name="jenisSurat" class="form-select" th:field="*{jenisSurat}">
                        <option value="">Pilih Jenis Surat</option>
                        <option th:each="jenisSurat : ${jenisSuratByKategori}" th:value="${jenisSurat.value}" th:text="${jenisSurat.value}"></option>
                    </select>
                </div>
            </div>
        </div>

        <div id="preview-template" class="preview-template">
            <div class="preview-title">Preview Template</div>
        </div>

        <div id="listFieldWrapper"></div>

        <div class="container" id="reqTemplateWrapper"></div>

        <div class="text-center action-buttons">
            <button type="submit" class="button">Ajukan Surat</button>
        </div>
    </form>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
            var kategoriDropdown = document.getElementById('kategori');
            var jenisSuratWrapper = document.getElementById('jenisSuratWrapper');
            var jenisSuratDropdown = document.getElementById('jenisSurat');
            var previewTemplateWrapper = document.getElementById('preview-template');
            var listFieldWrapper = document.getElementById('listFieldWrapper');
            var reqTemplateWrapper = document.getElementById('reqTemplateWrapper');

            jenisSuratWrapper.style.display = 'none';
            previewTemplateWrapper.style.display = 'none';
            listFieldWrapper.style.display = 'none';
            reqTemplateWrapper.style.display = 'none';

            kategoriDropdown.addEventListener('change', function () {
                previewTemplateWrapper.style.display = 'none';
                listFieldWrapper.style.display = 'none';
                if (kategoriDropdown.value !== '') {
                    jenisSuratWrapper.style.display = 'block';
                } else {
                    jenisSuratWrapper.style.display = 'none';
                }

                jenisSuratDropdown.innerHTML = '';

                var defaultOption = document.createElement('option');
                defaultOption.text = 'Pilih Jenis Surat';
                defaultOption.value = '';
                jenisSuratDropdown.appendChild(defaultOption);

                var selectedKategori = kategoriDropdown.value;
                var jenisSuratByKategori = /*[[${jenisSuratByKategori}]]*/ {};
                var jenisSuratList = jenisSuratByKategori[selectedKategori] ?? [];

                if (jenisSuratList) {
                    jenisSuratList.forEach(function (jenisSurat) {
                        var option = document.createElement('option');
                        option.text = jenisSurat;
                        option.value = jenisSurat;
                        jenisSuratDropdown.appendChild(option);
                    });

                    var lainnyaOption = document.createElement('option');
                    lainnyaOption.text = 'Lainnya';
                    lainnyaOption.value = 'Lainnya';
                    jenisSuratDropdown.appendChild(lainnyaOption);
                }
            });

            var base64PDF = /*[[${base64PDF}]]*/ '';
            jenisSuratDropdown.addEventListener('change', function() {

                // Remove all key elements if they exist
                const keyElements = document.querySelectorAll("[name^='listFieldData'][name$='.key']");
                keyElements.forEach(element => {
                    if (element) {
                        element.remove(); // Safely remove only if the element exists
                    }
                });

                // Remove all value elements if they exist
                const valueElements = document.querySelectorAll("[name^='listFieldData'][name$='.value']");
                valueElements.forEach(element => {
                    if (element) {
                        element.remove(); // Safely remove only if the element exists
                    }
                });

                if (jenisSuratDropdown.value == 'Lainnya') {
                    reqTemplateWrapper.style.display = 'block';
                    previewTemplateWrapper.style.display = 'none';
                    listFieldWrapper.style.display = 'none';

                    reqTemplateWrapper.innerHTML = '';

                    var labelDiv = document.createElement('div');
                    labelDiv.className = 'label';
                    labelDiv.textContent = 'Deskripsi Surat';

                    var formGroupDiv = document.createElement('div');
                    formGroupDiv.className = 'form-group';

                    var inputRowDiv = document.createElement('div');
                    inputRowDiv.className = 'input-row d-flex mt-3 mb-2';

                    var hiddenElement = document.createElement('input');
                    hiddenElement.type = 'hidden';
                    hiddenElement.name = 'listFieldData[0].key';
                    hiddenElement.value = 'Deskripsi Surat';

                    var textArea = document.createElement('textarea');
                    textArea.className = 'form-control';
                    textArea.placeholder = 'Beri penjelasan terkait surat yang diajukan sedetail mungkin. Anda juga dapat mencantumkan link referensi template surat yang Anda miliki. Kurangnya informasi yang diberikan dapat mengakibatkan pengajuan surat ditolak.';
                    textArea.name = 'listFieldData[0].value';
                    textArea.required = true;

                    // Upload file
                    var formGroupDiv = document.createElement('div');
                    formGroupDiv.className = 'form-group';

                    var uploadIllustrationFrameDiv = document.createElement('div');
                    uploadIllustrationFrameDiv.className = 'upload-illustration-frame';

                    var fileInputDiv = document.createElement('div');
                    fileInputDiv.className = 'file-input';

                    var secondaryMessageDiv = document.createElement('div');
                    secondaryMessageDiv.className = 'secondary-message';
                    secondaryMessageDiv.textContent = 'secondary message';

                    var rectangleFrameDiv = document.createElement('div');
                    rectangleFrameDiv.className = 'rectangle-frame';

                    var arsipSuratFrameDiv = document.createElement('div');
                    arsipSuratFrameDiv.className = 'arsip-surat-frame';

                    var buttonFrame1Div = document.createElement('div');
                    buttonFrame1Div.className = 'button-frame1';

                    var uploadIllustrationLabel = document.createElement('label');
                    uploadIllustrationLabel.className = 'upload-illustration';
                    uploadIllustrationLabel.setAttribute('for', 'file');

                    var chevronDownIconDiv = document.createElement('div');
                    chevronDownIconDiv.className = 'chevrondown-icon';

                    var wrapperGroupDiv = document.createElement('div');
                    wrapperGroupDiv.className = 'wrapper-group';

                    var groupIconImg = document.createElement('img');
                    groupIconImg.className = 'group-icon';
                    groupIconImg.alt = '';
                    groupIconImg.src = '/images/imagetengah.png';

                    var chevronDownIconChildImg = document.createElement('img');
                    chevronDownIconChildImg.className = 'chevrondown-icon-child';
                    chevronDownIconChildImg.alt = '';
                    chevronDownIconChildImg.src = '/images/upload.svg';

                    var chevronDownIconItemImg = document.createElement('img');
                    chevronDownIconItemImg.className = 'chevrondown-icon-item';
                    chevronDownIconItemImg.loading = 'lazy';
                    chevronDownIconItemImg.alt = '';
                    chevronDownIconItemImg.src = '/images/imagekanan.png';

                    var uploadIllustrationChildImg = document.createElement('img');
                    uploadIllustrationChildImg.className = 'upload-illustration-child';
                    uploadIllustrationChildImg.alt = '';
                    uploadIllustrationChildImg.src = '/images/imagekiri.png';

                    var inputFile = document.createElement('input');
                    inputFile.type = 'file';
                    inputFile.className = 'custom-file-input';
                    inputFile.id = 'file';
                    inputFile.name = 'file';

                    var uploadFileKamuContainer = document.createElement('h3');
                    uploadFileKamuContainer.className = 'upload-file-kamu-container';

                    var span1 = document.createElement('span');
                    span1.textContent = 'Upload';

                    var span2 = document.createElement('span');
                    span2.className = 'file-kamu-di';
                    span2.textContent = ' file kamu di sini dalam format .pdf';

                    var fileNameSpan = document.createElement('span');
                    fileNameSpan.className = 'file-name';

                    inputRowDiv.appendChild(hiddenElement);
                    inputRowDiv.appendChild(textArea);
                    formGroupDiv.appendChild(inputRowDiv);
                    reqTemplateWrapper.appendChild(labelDiv);
                    
                    uploadIllustrationLabel.appendChild(chevronDownIconDiv);
                    uploadIllustrationLabel.appendChild(uploadIllustrationChildImg);

                    chevronDownIconDiv.appendChild(wrapperGroupDiv);
                    wrapperGroupDiv.appendChild(groupIconImg);
                    chevronDownIconDiv.appendChild(chevronDownIconChildImg);
                    chevronDownIconDiv.appendChild(chevronDownIconItemImg);

                    buttonFrame1Div.appendChild(uploadIllustrationLabel);
                    buttonFrame1Div.appendChild(inputFile);
                    uploadFileKamuContainer.appendChild(span1);
                    uploadFileKamuContainer.appendChild(span2);

                    arsipSuratFrameDiv.appendChild(buttonFrame1Div);
                    arsipSuratFrameDiv.appendChild(uploadFileKamuContainer);
                    arsipSuratFrameDiv.appendChild(fileNameSpan);

                    rectangleFrameDiv.appendChild(arsipSuratFrameDiv);
                    fileInputDiv.appendChild(secondaryMessageDiv);
                    fileInputDiv.appendChild(rectangleFrameDiv);
                    uploadIllustrationFrameDiv.appendChild(fileInputDiv);
                    formGroupDiv.appendChild(uploadIllustrationFrameDiv);

                    reqTemplateWrapper.appendChild(formGroupDiv);

                    reqTemplateWrapper.style.display = 'block';

                } else if (jenisSuratDropdown.value !== '') {
                    previewTemplateWrapper.style.display = 'block';
                    listFieldWrapper.style.display = 'block';
                    reqTemplateWrapper.style.display = 'none';

                    // Mendapatkan jenis surat yang dipilih
                    var selectedJenisSurat = jenisSuratDropdown.value;

                    // Mendapatkan kategori surat yang dipilih
                    var selectedKategori = kategoriDropdown.value;

                    // Mendapatkan template surat yang sesuai dengan jenis surat yang dipilih
                    var listTemplateSurat = /*[[${listTemplateSurat}]]*/ [];
                    var selectedTemplate = listTemplateSurat.find(function(template) {
                        return template.namaTemplate === selectedJenisSurat && template.kategori === selectedKategori;
                    });

                    console.log("===== selectedTemplate:", selectedTemplate)


                    // Jika template ditemukan, tampilkan preview PDF
                    if (selectedTemplate) {
                        var base64PDF = selectedTemplate.file;
                        var listFieldData = selectedTemplate.listField;

                        previewTemplateWrapper.innerHTML = `
                        <div id="preview-title" class="preview-title">Preview Template</div>
                            <embed src='data:application/pdf;base64,${base64PDF}' type="application/pdf" width="100%" height="500px">
                        `;

                        listFieldWrapper.innerHTML = '';

                        if (selectedTemplate && selectedTemplate.listField) {
                            selectedTemplate.listField.forEach(function(field, index) {
                                // Create input element for each field
                                var inputDiv = document.createElement('div');
                                inputDiv.className = 'text-input';

                                var labelDiv = document.createElement('div');
                                labelDiv.className = 'label';
                                labelDiv.textContent = field;
                                console.log("===== labelDiv:", field)

                                var hiddenElement = document.createElement('input');
                                hiddenElement.type = 'hidden';
                                hiddenElement.className = 'form-control';
                                hiddenElement.name = `listFieldData[${index}].key`; // Menggunakan index
                                hiddenElement.field = field;
                                console.log("===== hiddenElement field:", field)

                                hiddenElement.value = field;
                                console.log("===== hiddenElement value:", field)

                                var textDiv = document.createElement('div');
                                textDiv.className = 'text-input7';

                                var inputElement = document.createElement('input');
                                inputElement.type = 'text';
                                inputElement.className = 'form-control';
                                inputElement.name = `listFieldData[${index}].value`; // Menggunakan index
                                inputElement.required = true;

                                var breakElement = document.createElement('br');

                                textDiv.appendChild(inputElement);
                                inputDiv.appendChild(labelDiv);
                                inputDiv.appendChild(hiddenElement);
                                inputDiv.appendChild(textDiv);
                                listFieldWrapper.appendChild(inputDiv);
                                listFieldWrapper.appendChild(breakElement);
                            });

                            listFieldWrapper.style.display = 'block';
                        }
                    } else {
                        previewTemplateWrapper.innerHTML = '<div class="error-message">Template tidak ditemukan untuk jenis surat yang dipilih.</div>';
                    }
                } else {
                    previewTemplateWrapper.style.display = 'none';
                    listFieldWrapper.style.display = 'none';
                }
            });
        });
        /*]]>*/
    </script>
</body>
</html>

