<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">


<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <object th:include="~{fragments/common :: js}" th:remove="tag"></object>
    <object th:include="~{fragments/common :: css}" th:remove="tag"></object>

    <link rel="stylesheet" href="/css/request-surat.css"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700&display=swap"/>

    <style>
        /* CSS untuk mengatur preview-template */
        #preview-template {
            display: none; /* Defaultnya disembunyikan */
            margin-top: 20px; /* Jarak antara form dan preview */
            padding: 20px; /* Padding agar tampilan lebih baik */
            background-color: transparent;
        }

        #preview-template embed {
            width: 100%; /* Mengatur agar ukuran PDF sesuai dengan lebar form */
            height: 500px; /* Tinggi tetap 500px */
        }

        #preview-title {
            font-size: 18px; /* Ukuran font judul */
            font-weight: bold; /* Tulisan judul menjadi tebal */
            margin-bottom: 10px; /* Jarak antara judul dengan konten preview */
        }
        .error-message {
            color: red; /* Warna teks merah */
            font-style: italic; /* Gaya teks menjadi miring */
            margin-top: 10px; /* Jarak antara pesan error dengan konten sebelumnya */
        }
    </style>

    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
            var kategoriDropdown = document.getElementById('kategori');
            var jenisSuratWrapper = document.getElementById('jenisSuratWrapper');
            var jenisSuratDropdown = document.getElementById('jenisSurat');
            var previewTemplateWrapper = document.getElementById('preview-template');
            var listFieldWrapper = document.getElementById('listFieldWrapper');
            var reqTemplateWrapper = document.getElementById('reqTemplateWrapper');
    
            // Sembunyikan judul dan dropdown jenis surat saat halaman dimuat
            jenisSuratWrapper.style.display = 'none';
            previewTemplateWrapper.style.display = 'none';
            listFieldWrapper.style.display = 'none';
            reqTemplateWrapper.style.display = 'none';
    
            // Tambahkan event listener untuk dropdown kategori surat
            kategoriDropdown.addEventListener('change', function () {
                // Tampilkan judul dan dropdown jenis surat jika kategori surat dipilih
                if (kategoriDropdown.value !== '') {
                    jenisSuratWrapper.style.display = 'block';
                } else {
                    // Sembunyikan judul dan dropdown jenis surat jika kategori surat tidak dipilih
                    jenisSuratWrapper.style.display = 'none';
                }
    
                // Hapus opsi yang ada di dropdown jenis surat
                jenisSuratDropdown.innerHTML = '';
    
                // Buat opsi default untuk dropdown jenis surat
                var defaultOption = document.createElement('option');
                defaultOption.text = 'Pilih Jenis Surat';
                defaultOption.value = '';
                jenisSuratDropdown.appendChild(defaultOption);
    
                // Tambahkan opsi jenis surat sesuai dengan kategori yang dipilih
                var selectedKategori = kategoriDropdown.value;
                var jenisSuratByKategori = /*[[${jenisSuratByKategori}]]*/ {};
                var jenisSuratList = jenisSuratByKategori[selectedKategori] ?? [];
    
                if (jenisSuratList) {
                    jenisSuratList.forEach(function (jenisSurat) {
                        var option = document.createElement('option');
                        option.text = jenisSurat;
                        option.value = jenisSurat;
                        jenisSuratDropdown.appendChild(option);
                    });

                    // Membuat dan menambahkan opsi 'Lainnya'
                    var lainnyaOption = document.createElement('option');
                    lainnyaOption.text = 'Lainnya';
                    lainnyaOption.value = 'Lainnya';
                    jenisSuratDropdown.appendChild(lainnyaOption);
                }
            });
    
            var base64PDF = /*[[${base64PDF}]]*/ '';
            jenisSuratDropdown.addEventListener('change', function() {
                if (jenisSuratDropdown.value == 'Lainnya') {
                    reqTemplateWrapper.style.display = 'block';
                    previewTemplateWrapper.style.display = 'none';
                    listFieldWrapper.style.display = 'none';

                } else if (jenisSuratDropdown.value !== '') {
                    previewTemplateWrapper.style.display = 'block';
                    listFieldWrapper.style.display = 'block';
                    reqTemplateWrapper.style.display = 'none';

                    // Change
                    const element = document.getElementsByName("listFieldData[0].key");
                    const element2 = document.getElementsByName("listFieldData[0].value");
                    element[0].remove();
                    element2[0].remove();

                    // Mendapatkan jenis surat yang dipilih
                    var selectedJenisSurat = jenisSuratDropdown.value;
    
                    // Mendapatkan kategori surat yang dipilih
                    var selectedKategori = kategoriDropdown.value;
    
                    // Mendapatkan template surat yang sesuai dengan jenis surat yang dipilih
                    var listTemplateSurat = /*[[${listTemplateSurat}]]*/ [];
                    var selectedTemplate = listTemplateSurat.find(function(template) {
                        return template.namaTemplate === selectedJenisSurat && template.kategori === selectedKategori;
                    });

                    console.log("===== selectedTemplate:", selectedTemplate)

    
                    // Jika template ditemukan, tampilkan preview PDF
                    if (selectedTemplate) {
                        var base64PDF = selectedTemplate.file;
                        var listFieldData = selectedTemplate.listField;

                        previewTemplateWrapper.innerHTML = `
                        <div id="preview-title">Preview Template</div>
                            <embed src='data:application/pdf;base64,${base64PDF}' type="application/pdf" width="100%" height="500px">
                        `;

                        listFieldWrapper.innerHTML = '';

                        if (selectedTemplate && selectedTemplate.listField) {
                            selectedTemplate.listField.forEach(function(field, index) {
                                // Create input element for each field
                                var inputDiv = document.createElement('div');
                                inputDiv.className = 'text-input';
                                
                                var labelDiv = document.createElement('div');
                                labelDiv.className = 'label';
                                labelDiv.textContent = field; 
                                
                                var hiddenElement = document.createElement('input');
                                hiddenElement.type = 'hidden';
                                hiddenElement.className = 'form-control';
                                hiddenElement.name = `listFieldData[${index}].key`; // Menggunakan index
                                hiddenElement.field = field;
                                hiddenElement.value = field;

                                var textDiv = document.createElement('div');
                                textDiv.className = 'text-input7';

                                var inputElement = document.createElement('input');
                                inputElement.type = 'text';
                                inputElement.className = 'form-control';
                                inputElement.name = `listFieldData[${index}].value`; // Menggunakan index
                                inputElement.required = true;
                                
                                var breakElement = document.createElement('br');

                                textDiv.appendChild(inputElement); 
                                inputDiv.appendChild(labelDiv);
                                inputDiv.appendChild(hiddenElement);
                                inputDiv.appendChild(textDiv);
                                listFieldWrapper.appendChild(inputDiv);
                                listFieldWrapper.appendChild(breakElement);
                            });

                            // After adding all fields, show the listFieldWrapper
                            listFieldWrapper.style.display = 'block';

                        }

                    } else {
                        // Jika tidak ada template yang sesuai, tampilkan pesan error
                        previewTemplateWrapper.innerHTML = '<div class="error-message">Template tidak ditemukan untuk jenis surat yang dipilih.</div>';
                    }
                } else {
                    // Sembunyikan preview jika tidak ada jenis surat yang dipilih
                    previewTemplateWrapper.style.display = 'none';
                    listFieldWrapper.style.display = 'none';
                }
            });
        });
        /*]]>*/
    </script>    
</head>


<body>
	<nav th:replace="~{fragments/navbarLoggedIn :: navbarLoggedIn}"></nav>

    <div class="ajukan-surat">
        <div class="home-frame">
        <b class="pengajuan-permohonan-surat-container">
            <span class="pengajuan">Pengajuan</span>
            <span> Permohonan Surat</span>
        </b>

        <img class="ajukan-surat-child" alt="" src="/images/kiri.svg" />
        <img class="ajukan-surat-item" alt="" src="/images/kanan.svg" />
    </div>

        <form th:action="@{/request}" th:object="${requestDTO}" method="POST">
            
            <div class="text-input-parent">
                <div class="text-input">
                    <div class="label">Bahasa</div>
                    <div class="text-input7">
                        <select name="bahasa" class="form-select" th:field="*{bahasa}">
                            <option value="">Pilih Bahasa Surat</option>
                            <option th:each="entry : ${listBahasa}" th:value="${entry.value}" th:text="${entry.value}"></option>
                        </select>
                    </div>
                </div>

                <div class="label-parent">
                    <div class="label">Bentuk Surat</div>
                    <div class="frame-parent">
                        <div class="radio-parent">
                            <input type="radio" id="softCopy" name="bentukSurat" value="Soft Copy" />
                            <div class="label-group">
                                <div class="body-14pt">Soft Copy</div>
                                <div class="body-14pt">Surat dapat diunduh di website ini.</div>
                            </div>
                        </div>
                        <div class="radio-parent">
                            <input type="radio" id="hardCopy" name="bentukSurat" value="Hard Copy" />
                            <div class="label-group">
                                <div class="body-14pt">Hard Copy</div>
                                <div class="body-14pt">Surat dapat diambil di kantor administrasi.</div>
                            </div>
                        </div>
                    </div>
                    <div class="error-message-wrapper">
                        <div class="placeholder">
                            Jika membutuhkan hardcopy dan softcopy untuk surat yang sama,
                            silakan buat dua pengajuan yang berbeda.
                        </div>
                    </div>
                </div>

                <div class="text-input">
                    <div class="label">Keperluan</div>
                    <div class="text-input7">
                        <input type="text" class="form-control" th:field="*{keperluan}" required/>
                    </div>
                </div>

                <div class="text-input">
                    <div class="label">Kategori Surat</div>
                    <div class="text-input7">
                        <select id="kategori" name="kategori" class="form-select" th:field="*{kategori}">
                            <option value="">Pilih Kategori Surat</option>
                            <option th:each="entry : ${jenisSuratByKategori}" th:value="${entry.key}" th:text="${entry.key}"></option>
                        </select>
                    </div>
                </div>

                <div>
                    <div class="text-input" id="jenisSuratWrapper">
                        <div class="label">Jenis Surat</div>
                        <div class="text-input7">
                            <select id="jenisSurat" name="jenisSurat" class="form-select" th:field="*{jenisSurat}">
                                <option value="">Pilih Jenis Surat</option>
                                <option th:each="jenisSurat : ${jenisSuratByKategori}" th:value="${jenisSurat.value}" th:text="${jenisSurat.value}"></option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="preview-template">
                    PREVIEW TEMPLATE
                </div>

                <div id="listFieldWrapper"></div>

                <div class="container" id="reqTemplateWrapper">
                    <div class="label">Data yang diperlukan</div>
                    <div id="list-field-data" class="form-group">
                        <div class="input-row d-flex mt-3 mb-2">
                            <input type="text" class="form-control" placeholder="Nama Perusahaan" name="listFieldData[0].key" required>
                            <input type="text" class="form-control" placeholder="Jalan Sudirman ..." name="listFieldData[0].value" required>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-primary" onclick="addRow()" style="background-color:#0f7454;">Tambah Field</button>
                    </div>
                </div>                

                <div class="text-center action-buttons">
                    <button type="submit" class="button">Ajukan Surat</button>
                </div>
            </div>
        </form>
    </div>    
    
    <footer th:replace="~{fragments/footer :: footer}"></footer>

<script>

function addRow() {
    const container = document.getElementById('list-field-data');
    const numberOfRows = container.getElementsByClassName('input-row').length;

    // Membuat div baru untuk row input
    const newRow = document.createElement('div');
    newRow.className = 'input-row d-flex mt-3 mb-2';

    // Membuat input untuk key dengan notasi index
    const newKeyInput = document.createElement('input');
    newKeyInput.type = 'text';
    newKeyInput.className = 'form-control';
    newKeyInput.placeholder = 'Nama Perusahaan';
    newKeyInput.name = `listFieldData[${numberOfRows}].key`; // Menggunakan index
    newKeyInput.required = true;

    // Membuat input untuk value dengan notasi index
    const newValueInput = document.createElement('input');
    newValueInput.type = 'text';
    newValueInput.className = 'form-control';
    newValueInput.placeholder = 'Jalan Sudirman ...';
    newValueInput.name = `listFieldData[${numberOfRows}].value`; // Menggunakan index
    newValueInput.required = true;

    // Menambahkan input ke dalam newRow
    newRow.appendChild(newKeyInput);
    newRow.appendChild(newValueInput);

    // Menambahkan newRow ke dalam container
    container.appendChild(newRow);
}


</script>

</body>
</html>